VERSION --wildcard-builds --wildcard-copy 0.8

IMPORT github.com/formancehq/earthly:tags/v0.16.3 AS core
IMPORT ../.. AS root

sources:
  FROM core+base-image
  WORKDIR /src
  COPY go.* .
  COPY --dir suite .
  # TODO(david): refactor tests to base test on specific helm package name-version.tgz
  # Then we can remove this line, and COPY root+packages/* /build 
  COPY --dir (root+sources/*/charts --PATH=charts) .
  SAVE ARTIFACT /src

tests:
  FROM core+builder-image
  RUN apk add helm
  WORKDIR /src
  COPY (+sources/*) .
  
  ARG additionalArgs
  ENV CHART_DIR /src/charts/
  ENV CGO_ENABLED=1
  RUN --mount=type=cache,id=gomod,target=${GOPATH}/pkg/mod \
      --mount=type=cache,id=gobuild,target=/root/.cache/go-build \
      --mount=type=cache,id=golangci,target=/root/.cache/golangci-lint \
      go test ./... -race $additionalArgs